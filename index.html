<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDMX Air Quality Data</title>
    <!-- Add Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2, h3, h4 {
            color: #2c3e50;
        }
        .controls {
            background-color: #f8f9fa;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
            gap: 15px;
            align-items: flex-end;
        }
        .form-group {
            margin-bottom: 10px;
            flex: 1;
            min-width: 150px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        select, input, button {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ced4da;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            padding: 10px 15px;
            font-weight: bold;
        }
        button:hover {
            background-color: #0069d9;
        }
        .button-primary {
            background-color: #28a745;
        }
        .button-secondary {
            background-color: #6c757d;
        }
        .status {
            margin: 15px 0;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        .loading {
            background-color: #cce5ff;
            border: 1px solid #b8daff;
            color: #004085;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9em;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #dee2e6;
        }
        th {
            background-color: #e9ecef;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .data-section {
            margin-top: 30px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        .data-section-header {
            background-color: #e9ecef;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .data-section-content {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .stats-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        .stat-item {
            background-color: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .stat-title {
            font-size: 0.8em;
            color: #6c757d;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
        }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #dee2e6;
            font-size: 0.9em;
        }
        .tab-container {
            margin-top: 20px;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #dee2e6;
        }
        .tab-button {
            padding: 10px 15px;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            background-color: transparent;
            cursor: pointer;
            margin-right: 5px;
            font-weight: normal;
            color: #495057;
        }
        .tab-button.active {
            background-color: white;
            border-color: #dee2e6;
            color: #007bff;
            font-weight: bold;
        }
        .tab-content {
            padding: 20px;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }
        .tab-pane {
            display: none;
        }
        .tab-pane.active {
            display: block;
        }
        .proxy-url {
            margin-top: 10px;
            font-size: 0.8em;
            color: #6c757d;
        }
        .proxy-url input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CDMX Air Quality Data Viewer</h1>
        <p>View real-time air quality data from Mexico City's monitoring network.</p>
        
        <div class="proxy-url">
            <label for="proxyUrl">CORS Proxy URL:</label>
            <input type="text" id="proxyUrl" value="/.netlify/functions/proxy" placeholder="Enter your proxy server URL">
        </div>
            
            <h2>Query Parameters</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="parameter">Parameter:</label>
                    <select id="parameter">
                        <option value="o3" selected>Ozone (O3)</option>
                        <option value="o3_8h">Ozone 8-hour (O3_8h)</option>
                        <option value="pm10">PM10</option>
                        <option value="pm10nowCast">PM10 (nowCast)</option>
                        <option value="pm25">PM2.5</option>
                        <option value="pm25nowCast">PM2.5 (nowCast)</option>
                        <option value="so2">Sulfur Dioxide (SO2)</option>
                        <option value="co">Carbon Monoxide (CO)</option>
                        <option value="nox">Nitrogen Oxides (NOx)</option>
                        <option value="no2">Nitrogen Dioxide (NO2)</option>
                        <option value="no">Nitric Oxide (NO)</option>
                        <option value="wsp">Wind Speed (WSP)</option>
                        <option value="wdr">Wind Direction (WDR)</option>
                        <option value="tmp">Temperature (TMP)</option>
                        <option value="rh">Relative Humidity (RH)</option>
                    </select>
                </div>
                
                <div class="form-group">
                <label for="year">Year:</label>
                <select id="year">
                    <option value="all">All Years</option>
                    <option value="2025" selected>2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                    <option value="2021">2021</option>
                    <option value="2020">2020</option>
                    <option value="2019">2019</option>
                    <option value="2018">2018</option>
                    <option value="2017">2017</option>
                    <option value="2016">2016</option>
                    <option value="2015">2015</option>
                    <option value="2014">2014</option>
                    <option value="2013">2013</option>
                    <option value="2012">2012</option>
                    <option value="2011">2011</option>
                    <option value="2010">2010</option>
                    <option value="2009">2009</option>
                    <option value="2008">2008</option>
                    <option value="2007">2007</option>
                    <option value="2006">2006</option>
                    <option value="2005">2005</option>
                </select>
            </div>
                
                <div class="form-group">
                    <label for="month">Month:</label>
                    <select id="month">
                        <option value="all">All Months</option>
                        <option value="01">January</option>
                        <option value="02">February</option>
                        <option value="03" selected>March</option>
                        <option value="04">April</option>
                        <option value="05">May</option>
                        <option value="06">June</option>
                        <option value="07">July</option>
                        <option value="08">August</option>
                        <option value="09">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="day">Day (optional):</label>
                    <select id="day">
                        <option value="">All Days</option>
                        <option value="01">1</option>
                        <option value="02">2</option>
                        <option value="03">3</option>
                        <option value="04">4</option>
                        <option value="05">5</option>
                        <option value="06">6</option>
                        <option value="07">7</option>
                        <option value="08">8</option>
                        <option value="09">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                        <option value="24">24</option>
                        <option value="25">25</option>
                        <option value="26">26</option>
                        <option value="27">27</option>
                        <option value="28">28</option>
                        <option value="29">29</option>
                        <option value="30">30</option>
                        <option value="31">31</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="hour">Hour (optional):</label>
                    <select id="hour">
                        <option value="">All Hours</option>
                        <option value="00">00:00</option>
                        <option value="01">01:00</option>
                        <option value="02">02:00</option>
                        <option value="03">03:00</option>
                        <option value="04">04:00</option>
                        <option value="05">05:00</option>
                        <option value="06">06:00</option>
                        <option value="07">07:00</option>
                        <option value="08">08:00</option>
                        <option value="09">09:00</option>
                        <option value="10">10:00</option>
                        <option value="11">11:00</option>
                        <option value="12">12:00</option>
                        <option value="13">13:00</option>
                        <option value="14">14:00</option>
                        <option value="15">15:00</option>
                        <option value="16">16:00</option>
                        <option value="17">17:00</option>
                        <option value="18">18:00</option>
                        <option value="19">19:00</option>
                        <option value="20">20:00</option>
                        <option value="21">21:00</option>
                        <option value="22">22:00</option>
                        <option value="23">23:00</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="station">Station (optional):</label>
                        <select id="station">
                            <option value="">All Stations</option>
                            <option value="ACO">Acolman (ACO)</option>
                            <option value="AJM">Ajusco Medio (AJM)</option>
                            <option value="ATI">Atizapán (ATI)</option>
                            <option value="BJU">Benito Juárez (BJU)</option>
                            <option value="CAM">Camarones (CAM)</option>
                            <option value="CCA">Centro de Ciencias (CCA)</option>
                            <option value="CHO">Chalco (CHO)</option>
                            <option value="CUA">Cuajimalpa (CUA)</option>
                            <option value="CUT">Cuautitlán (CUT)</option>
                            <option value="FAC">FES Acatlán (FAC)</option>
                            <option value="GAM">Gustavo A. Madero (GAM)</option>
                            <option value="HGM">Hospital General (HGM)</option>
                            <option value="INN">Iztacalco (INN)</option>
                            <option value="IZT">Iztapalapa (IZT)</option>
                            <option value="LLA">Los Laureles (LLA)</option>
                            <option value="LPR">La Presa (LPR)</option>
                            <option value="MER">Merced (MER)</option>
                            <option value="MGH">Miguel Hidalgo (MGH)</option>
                            <option value="MPA">Milpa Alta (MPA)</option>
                            <option value="NEZ">Nezahualcóyotl (NEZ)</option>
                            <option value="PED">Pedregal (PED)</option>
                            <option value="SAC">Santiago (SAC)</option>
                            <option value="SAG">San Agustín (SAG)</option>
                            <option value="SFE">Santa Fe (SFE)</option>
                            <option value="TAH">Tláhuac (TAH)</option>
                            <option value="TLA">Tlalnepantla (TLA)</option>
                            <option value="TLI">Tultitlán (TLI)</option>
                            <option value="UAX">UAM Xochimilco (UAX)</option>
                            <option value="UIZ">UAM Iztapalapa (UIZ)</option>
                            <option value="VIF">Villa de las Flores (VIF)</option>
                            <option value="XAL">Xalostoc (XAL)</option>
                        </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <button id="fetchDataBtn" class="button-primary">Fetch Data</button>
                </div>
                <div class="form-group">
                    <button id="clearResultsBtn" class="button-secondary">Clear Results</button>
                </div>
            </div>
        </div>
        
        <div id="status" class="status"></div>
        
        <div id="resultsContainer" style="display: none;">
            <div class="stats-box">
                <h3>Query Summary</h3>
                <div id="querySummary"></div>
                
                <h3>Data Statistics</h3>
                <div class="stats-grid" id="statsGrid">
                    <!-- Stats items will be populated here -->
                </div>
            </div>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="tabRawData">Raw Data</button>
                    <button class="tab-button" data-tab="tabAverages">Hourly Averages</button>
                    <button class="tab-button" data-tab="tabStations">Station Data</button>
                    <button class="tab-button" data-tab="tabChart">Chart</button>
                </div>
                
                <div class="tab-content">
                    <div class="tab-pane active" id="tabRawData">
                        <div id="rawDataTable"></div>
                    </div>
                    
                    <div class="tab-pane" id="tabAverages">
                         <div id="averagesContainer">
                            <div id="averagesTable"></div>
                        </div>
                    </div>
                    
                    <div class="tab-pane" id="tabStations">
                        <div id="stationsContainer">
                            <div id="stationsData"></div>
                        </div>
                    </div>
                    
                    <div class="tab-pane" id="tabChart">
                       <!-- Add this as a new control in the tab-pane for the Chart tab -->
<div id="chartControls" class="controls" style="margin-bottom: 15px;">
                            <div class="form-group">
                                <label for="stationCompare">Compare Stations (select multiple):</label>
                                <select id="stationCompare" multiple style="height: 120px;">
                                    <option value="ACO">Acolman (ACO)</option>
                                    <option value="AJM">Ajusco Medio (AJM)</option>
                                    <option value="ATI">Atizapán (ATI)</option>
                                    <option value="BJU">Benito Juárez (BJU)</option>
                                    <option value="CAM">Camarones (CAM)</option>
                                    <option value="CCA">Centro de Ciencias (CCA)</option>
                                    <option value="CHO">Chalco (CHO)</option>
                                    <option value="CUA">Cuajimalpa (CUA)</option>
                                    <option value="CUT">Cuautitlán (CUT)</option>
                                    <option value="FAC">FES Acatlán (FAC)</option>
                                    <option value="GAM">Gustavo A. Madero (GAM)</option>
                                    <option value="HGM">Hospital General (HGM)</option>
                                    <option value="INN">Iztacalco (INN)</option>
                                    <option value="IZT">Iztapalapa (IZT)</option>
                                    <option value="LLA">Los Laureles (LLA)</option>
                                    <option value="LPR">La Presa (LPR)</option>
                                    <option value="MER">Merced (MER)</option>
                                    <option value="MGH">Miguel Hidalgo (MGH)</option>
                                    <option value="MPA">Milpa Alta (MPA)</option>
                                    <option value="NEZ">Nezahualcóyotl (NEZ)</option>
                                    <option value="PED">Pedregal (PED)</option>
                                    <option value="SAC">Santiago (SAC)</option>
                                    <option value="SAG">San Agustín (SAG)</option>
                                    <option value="SFE">Santa Fe (SFE)</option>
                                    <option value="TAH">Tláhuac (TAH)</option>
                                    <option value="TLA">Tlalnepantla (TLA)</option>
                                    <option value="TLI">Tultitlán (TLI)</option>
                                    <option value="UAX">UAM Xochimilco (UAX)</option>
                                    <option value="UIZ">UAM Iztapalapa (UIZ)</option>
                                    <option value="VIF">Villa de las Flores (VIF)</option>
                                    <option value="XAL">Xalostoc (XAL)</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <button id="compareBtn" class="button-primary">Update Comparison</button>
                                </div>
                                <div class="form-group">
                                    <button id="clearCompareBtn" class="button-secondary">Clear Comparison</button>
                                </div>
                            </div>
                        </div> 
                        <div id="chartContainer" style="width: 100%; height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Import the data retrieval script -->
    <script src="airqualitydata.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Tab switching logic
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all tabs
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('active');
                    });
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Clear results button
            document.getElementById('clearResultsBtn').addEventListener('click', function() {
                document.getElementById('resultsContainer').style.display = 'none';
                document.getElementById('status').style.display = 'none';
                document.getElementById('rawDataTable').innerHTML = '';
                document.getElementById('averagesTable').innerHTML = '';
                document.getElementById('stationsData').innerHTML = '';
                document.getElementById('querySummary').innerHTML = '';
                document.getElementById('statsGrid').innerHTML = '';
                
                // Clear any charts
                if (window.airQualityChart) {
                    window.airQualityChart.destroy();
                    window.airQualityChart = null;
                }
            });
            
            // Fetch data button
            document.getElementById('fetchDataBtn').addEventListener('click', fetchAirQualityData);
            // When the Compare button is clicked
            document.getElementById('compareBtn').addEventListener('click', function() {
                const stationCompare = document.getElementById('stationCompare');
                const selectedStations = Array.from(stationCompare.selectedOptions).map(option => option.value);
                
                if (selectedStations.length === 0) {
                    showStatus('info', 'Please select at least one station to compare.');
                    return;
                }
                
                // Show loading status
                showStatus('loading', `Comparing ${selectedStations.length} stations...`);
                
                // We'll reuse the existing data if already fetched
                if (window.currentData && window.currentProcessed) {
                    displayResults(window.currentData, window.currentProcessed, document.getElementById('parameter').value);
                    
                    // For instant feedback, switch to the chart tab
                    document.querySelector('.tab-button[data-tab="tabChart"]').click();
                    
                    showStatus('success', `Showing comparison of ${selectedStations.length} stations`);
                } else {
                    // If no data is loaded yet, trigger the fetch
                    document.getElementById('fetchDataBtn').click();
                }
            });
            
            // When the Clear Comparison button is clicked
            document.getElementById('clearCompareBtn').addEventListener('click', function() {
                const stationCompare = document.getElementById('stationCompare');
                
                // Clear all selected options
                for (let i = 0; i < stationCompare.options.length; i++) {
                    stationCompare.options[i].selected = false;
                }
                
                // If we have data, update the display
                if (window.currentData && window.currentProcessed) {
                    displayResults(window.currentData, window.currentProcessed, document.getElementById('parameter').value);
                    showStatus('info', 'Station comparison cleared');
                }
            })
            // Add this to your displayResults function to store the current data for comparison use
            function displayResults(data, processed, parameter) {
                // Store the data for comparison use
                window.currentData = data;
                window.currentProcessed = processed;
            }
            
            // Function to show status message
            function showStatus(type, message) {
                const statusElement = document.getElementById('status');
                statusElement.textContent = message;
                statusElement.className = 'status ' + type;
                statusElement.style.display = 'block';
            }
            
            // Function to fetch air quality data
            async function fetchAirQualityData() {
                // Get form values
                const proxyUrl = document.getElementById('proxyUrl').value;
                const parameter = document.getElementById('parameter').value;
                const year = document.getElementById('year').value;
                const month = document.getElementById('month').value;
                const day = document.getElementById('day').value;
                const hour = document.getElementById('hour').value;
                const station = document.getElementById('station').value;
                
                // Show loading status
                showStatus('loading', 'Fetching data from CDMX air quality monitoring network...');
                
                try {
                    // Override the proxy URL if specified
                    window.airQualityData.proxyUrl = proxyUrl;
                    
                    // Handle the "all years" and "all months" options
                    let combinedData = [];
                    
                    if (year === 'all' && month === 'all') {
                        // Limit to last 3 years to avoid too much data
                        const currentDate = new Date();
                        const currentYear = currentDate.getFullYear();
                        showStatus('loading', 'Fetching multiple years of data (this may take a while)...');
                        
                        // Fetch last 3 years of data, one month at a time
                        for (let y = currentYear; y >= currentYear - 2; y--) {
                            for (let m = 1; m <= 12; m++) {
                                // Skip future months in current year
                                if (y === currentYear && m > currentDate.getMonth() + 1) {
                                    continue;
                                }
                                
                                const monthStr = m.toString().padStart(2, '0');
                                showStatus('loading', `Fetching data for ${y}-${monthStr}...`);
                                
                                try {
                                    const monthData = await window.airQualityData.fetch(
                                        parameter, 
                                        y.toString(), 
                                        monthStr, 
                                        day || null, 
                                        hour || null, 
                                        station || null
                                    );
                                    combinedData = combinedData.concat(monthData);
                                    showStatus('loading', `Retrieved ${monthData.length} data points for ${y}-${monthStr}. Total: ${combinedData.length} points...`);
                                } catch (err) {
                                    console.warn(`Error fetching ${y}-${monthStr}:`, err);
                                    // Continue despite errors
                                }
                            }
                        }
                    } 
                    else if (year === 'all') {
                        // Fetch the selected month across multiple years
                        const currentDate = new Date();
                        const currentYear = currentDate.getFullYear();
                        showStatus('loading', 'Fetching multiple years of data (this may take a while)...');
                        
                        // Fetch last 5 years for the specific month
                        for (let y = currentYear; y >= currentYear - 4; y--) {
                            // Skip future months
                            if (y === currentYear && parseInt(month) > currentDate.getMonth() + 1) {
                                continue;
                            }
                            
                            showStatus('loading', `Fetching data for ${y}-${month}...`);
                            
                            try {
                                const yearData = await window.airQualityData.fetch(
                                    parameter, 
                                    y.toString(), 
                                    month, 
                                    day || null, 
                                    hour || null, 
                                    station || null
                                );
                                combinedData = combinedData.concat(yearData);
                                showStatus('loading', `Retrieved ${yearData.length} data points for ${y}-${month}. Total: ${combinedData.length} points...`);
                            } catch (err) {
                                console.warn(`Error fetching ${y}-${month}:`, err);
                                // Continue despite errors
                            }
                        }
                    } 
                    else if (month === 'all') {
                        // Fetch all months for a specific year
                        showStatus('loading', `Fetching all months for ${year}...`);
                        
                        // Limit to months that have already passed in current year
                        const currentDate = new Date();
                        const maxMonth = (parseInt(year) === currentDate.getFullYear()) 
                            ? currentDate.getMonth() + 1 
                            : 12;
                        
                        for (let m = 1; m <= maxMonth; m++) {
                            const monthStr = m.toString().padStart(2, '0');
                            showStatus('loading', `Fetching data for ${year}-${monthStr}...`);
                            
                            try {
                                const monthData = await window.airQualityData.fetch(
                                    parameter, 
                                    year, 
                                    monthStr, 
                                    day || null, 
                                    hour || null, 
                                    station || null
                                );
                                combinedData = combinedData.concat(monthData);
                                showStatus('loading', `Retrieved ${monthData.length} data points for ${year}-${monthStr}. Total: ${combinedData.length} points...`);
                            } catch (err) {
                                console.warn(`Error fetching ${year}-${monthStr}:`, err);
                                // Continue despite errors
                            }
                        }
                    } 
                    else {
                        // Regular single month fetch
                        combinedData = await window.airQualityData.fetch(
                            parameter, 
                            year, 
                            month, 
                            day || null, 
                            hour || null, 
                            station || null
                        );
                    }
                    
                    // Process the data
                    const processed = window.airQualityData.process(combinedData);
                    
                    // Show success status
                    showStatus('success', `Successfully retrieved ${combinedData.length} data points`);
                    
                    // Display the results with filtering
                    displayResults(combinedData, processed, parameter);
                    
                    // Show results container
                    document.getElementById('resultsContainer').style.display = 'block';
                } catch (error) {
                    console.error('Error fetching data:', error);
                    showStatus('error', `Error: ${error.message}`);
                }
            }
            
// Function to display results
function displayResults(data, processed, parameter) {
    // Filter data according to the selected parameters
    const day = document.getElementById('day').value;
    const hour = document.getElementById('hour').value;
    const station = document.getElementById('station').value;
    
    let filteredData = data;
    
    // Apply filters based on selected parameters
    if (station) {
        filteredData = filteredData.filter(item => item.station === station);
    }
    
    if (day && hour) {
        // Filter for specific date and hour
        filteredData = filteredData.filter(item => 
            item.date.endsWith(`-${day}`) && item.hour === hour);
    } else if (day) {
        // Filter for specific date only
        filteredData = filteredData.filter(item => 
            item.date.endsWith(`-${day}`));
    } else if (hour) {
        // Filter for specific hour only
        filteredData = filteredData.filter(item => 
            item.hour === hour);
    }
    
    // Re-process filtered data to get correct averages
    const filteredProcessed = processAirQualityData(filteredData);

    // Update query summary
    displayQuerySummary(filteredData, parameter, day, hour, station);
    
    // Display statistics
    displayStatistics(filteredData, filteredProcessed);
    
    // Display raw data table
    displayRawData(filteredData, parameter);
    
    // Check if the containers exist before accessing their style
    const averagesContainer = document.getElementById('averagesContainer');
    const stationsContainer = document.getElementById('stationsContainer');
    
    // Display hourly averages
    if (averagesContainer) {
        if (!hour) {
            // Only show hourly averages if not filtered to a specific hour
            displayHourlyAverages(filteredProcessed.hourlyAverages, parameter);
            averagesContainer.style.display = 'block';
        } else {
            averagesContainer.style.display = 'none';
        }
    }
    
    // Display station data
    if (stationsContainer) {
        if (!station) {
            // Only show station breakdown if not filtered to a specific station
            displayStationData(filteredProcessed.stations, parameter);
            stationsContainer.style.display = 'block';
        } else {
            stationsContainer.style.display = 'none';
        }
    }
    
    // Display chart
    displayChart(filteredProcessed, parameter);
}

// Function to display query summary
function displayQuerySummary(data, parameter, day, hour, station) {
    const querySummary = document.getElementById('querySummary');
    
    // Get form values
    const year = document.getElementById('year').value;
    const month = document.getElementById('month').value;
    
    // Build summary
    let summary = `<p><strong>Parameter:</strong> ${parameter.toUpperCase()}</p>`;
    
    if (day) {
        summary += `<p><strong>Date:</strong> ${year}-${month}-${day}</p>`;
    } else {
        summary += `<p><strong>Month:</strong> ${year}-${month}</p>`;
    }
    
    if (hour) {
        summary += `<p><strong>Hour:</strong> ${hour}:00</p>`;
    }
    
    if (station) {
        summary += `<p><strong>Station:</strong> ${station}</p>`;
    }
    
    // Show result count
    summary += `<p><strong>Results:</strong> ${data.length} data points displayed</p>`;
    
    // Get date range if multiple dates
    if (!day && data.length > 0) {
        const dates = [...new Set(data.map(item => item.date))].sort();
        if (dates.length > 1) {
            summary += `<p><strong>Date Range:</strong> ${dates[0]} to ${dates[dates.length-1]}</p>`;
        }
    }
    
    querySummary.innerHTML = summary;
}
            
            // Function to display statistics
            function displayStatistics(data, processed) {
                const statsGrid = document.getElementById('statsGrid');
                statsGrid.innerHTML = '';
                
                if (data.length === 0) {
                    statsGrid.innerHTML = '<p>No data available to display statistics</p>';
                    return;
                }
                
                // Get unique stations
                const stations = Object.keys(processed.stations);
                
                // Get unique dates
                const dates = [...new Set(data.map(item => item.date))];
                
                // Get unique hours
                const hours = [...new Set(data.map(item => item.hour))];
                
                // Calculate min, max, and average values
                const values = data.map(item => item.value);
                const min = Math.min(...values);
                const max = Math.max(...values);
                const avg = values.reduce((sum, val) => sum + val, 0) / values.length;
                
                // Create stat items
                addStatItem(statsGrid, 'Total Records', data.length);
                addStatItem(statsGrid, 'Stations', `${stations.length} stations`);
                addStatItem(statsGrid, 'Dates', `${dates.length} day(s)`);
                addStatItem(statsGrid, 'Hours', `${hours.length} hour(s)`);
                addStatItem(statsGrid, 'Min Value', min.toFixed(1));
                addStatItem(statsGrid, 'Max Value', max.toFixed(1));
                addStatItem(statsGrid, 'Average Value', avg.toFixed(1));
            }
            
            // Function to add a stat item
            function addStatItem(container, title, value) {
                const item = document.createElement('div');
                item.className = 'stat-item';
                
                const titleEl = document.createElement('div');
                titleEl.className = 'stat-title';
                titleEl.textContent = title;
                
                const valueEl = document.createElement('div');
                valueEl.className = 'stat-value';
                valueEl.textContent = value;
                
                item.appendChild(titleEl);
                item.appendChild(valueEl);
                container.appendChild(item);
            }
            
            // Function to display raw data table
            function displayRawData(data, parameter, limit = 100) {
                const container = document.getElementById('rawDataTable');
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<p>No data available</p>';
                    return;
                }
                
                // Limit the number of items to display
                const displayData = data.slice(0, limit);
                
                // Create table
                let html = `
                    <h3>Raw Data (showing ${displayData.length} of ${data.length} records)</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Hour</th>
                                <th>Value (${getParameterUnit(parameter)})</th>
                                <th>Station</th>
                                <th>Quality</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // Add rows
                displayData.forEach(item => {
                    const quality = item.value !== null ? 
                        window.airQualityData.getCategory(parameter, item.value) : 
                        { category: 'No Data', color: '#cccccc' };
                    
                    html += `
                        <tr>
                            <td>${item.date}</td>
                            <td>${item.hour}:00</td>
                            <td>${item.value !== null ? item.value : item.rawValue}</td>
                            <td>${item.station}</td>
                            <td style="background-color: ${quality.color}; color: ${getContrastColor(quality.color)}">
                                ${quality.category}
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                // If there's more data than shown, indicate that
                if (data.length > limit) {
                    html += `<p>Showing ${limit} of ${data.length} records</p>`;
                }
                
                container.innerHTML = html;
            }
            
            // Function to display hourly averages
            function displayHourlyAverages(averages, parameter) {
                const container = document.getElementById('averagesTable');
                
                if (!averages || averages.length === 0) {
                    container.innerHTML = '<p>No hourly averages available</p>';
                    return;
                }
                
                // Create table
                let html = `
                    <h3>Hourly Averages (${averages.length} records)</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Hour</th>
                                <th>Average Value (${getParameterUnit(parameter)})</th>
                                <th>Stations Reporting</th>
                                <th>Quality</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // Add rows
                averages.forEach(item => {
                    const quality = window.airQualityData.getCategory(parameter, item.value);
                    
                    html += `
                        <tr>
                            <td>${item.date}</td>
                            <td>${item.hour}:00</td>
                            <td>${item.value}</td>
                            <td>${item.stationCount}</td>
                            <td style="background-color: ${quality.color}; color: ${getContrastColor(quality.color)}">
                                ${quality.category}
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                container.innerHTML = html;
            }
            
            // Function to display station data
            function displayStationData(stations, parameter) {
                const container = document.getElementById('stationsData');
                
                if (!stations || Object.keys(stations).length === 0) {
                    container.innerHTML = '<p>No station data available</p>';
                    return;
                }
                
                let html = `<h3>Data by Station (${Object.keys(stations).length} stations)</h3>`;
                
                // Add an accordion for each station
                Object.keys(stations).sort().forEach((stationId, index) => {
                    const stationData = stations[stationId];
                    
                    html += `
                        <div class="data-section">
                            <div class="data-section-header">
                                <span>Station: ${stationId}</span>
                                <span>${stationData.length} records</span>
                            </div>
                            <div class="data-section-content">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Hour</th>
                                            <th>Value (${getParameterUnit(parameter)})</th>
                                            <th>Quality</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    // Sort by date and hour
                    stationData.sort((a, b) => {
                        if (a.date !== b.date) return a.date.localeCompare(b.date);
                        return parseInt(a.hour) - parseInt(b.hour);
                    });
                    
                    // Add rows
                    stationData.forEach(item => {
                        const quality = window.airQualityData.getCategory(parameter, item.value);
                        
                        html += `
                            <tr>
                                <td>${item.date}</td>
                                <td>${item.hour}:00</td>
                                <td>${item.value}</td>
                                <td style="background-color: ${quality.color}; color: ${getContrastColor(quality.color)}">
                                    ${quality.category}
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
            
// Function to display chart using Plotly
// Function to display chart using Plotly
function displayChart(processed, parameter) {
    // Get the chart container
    const chartContainer = document.getElementById('chartContainer');
    chartContainer.innerHTML = '';
    
    // Get selected station for title display
    const selectedStation = document.getElementById('station').value;
    
    let plotData = [];
    let layout = {
        // Add station name to title if a specific station is selected
        title: selectedStation 
            ? `${parameter.toUpperCase()} Air Quality Data - Station: ${selectedStation}`
            : `${parameter.toUpperCase()} Air Quality Data`,
        xaxis: {
            title: 'Date & Time',
            tickangle: -45,
            tickfont: {
                size: 10
            }
        },
        yaxis: {
            title: `${parameter.toUpperCase()} (${getParameterUnit(parameter)})`,
            zeroline: false
        },
        showlegend: true,
        hovermode: 'closest',
        margin: {
            l: 50,
            r: 50,
            b: 70,
            t: 50,
            pad: 4
        }
    };
    
    // Add threshold line for ozone at 155 ppb
    if (parameter.toLowerCase() === 'o3') {
        layout.shapes = [{
            type: 'line',
            x0: 0,
            y0: 155,
            x1: 1,
            y1: 155,
            xref: 'paper',
            yref: 'y',
            line: {
                color: 'red',
                width: 2,
                dash: 'dash'
            }
        }];
        
        // Add annotation for the threshold line with more space
        layout.annotations = [{
            x: 0.05,  // Moved from 0.02 to 0.05 for spacing
            y: 165,   // Increased from 158 to 165 for more space
            xref: 'paper',
            yref: 'y',
            text: 'Smog Alert Phase I Threshold (155 ppb)',
            showarrow: false,
            font: {
                color: 'red',
                size: 12
            }
        }];
    }
    
    // Get comparison stations from dropdown if it exists
    const comparisonSelect = document.getElementById('stationCompare');
    let comparisonStations = [];
    
    if (comparisonSelect && comparisonSelect.value) {
        comparisonStations = comparisonSelect.value.split(',').filter(s => s.trim() !== '');
    }
    
    // Check if we have hourly averages or need to show by station
    if (processed.hourlyAverages && processed.hourlyAverages.length > 0 && 
        (!comparisonStations.length && !selectedStation)) {
        // Use hourly averages (single line chart)
        const data = processed.hourlyAverages;
        
        // Sort data by date and time
        data.sort((a, b) => {
            if (a.date !== b.date) return a.date.localeCompare(b.date);
            return parseInt(a.hour) - parseInt(b.hour);
        });
        
        // Create traces with explicit null gaps (important fix)
        const traces = createTracesWithGaps(data, 'date', 'hour', 'value', {
            color: 'black',
            name: `${parameter.toUpperCase()} - Hourly Average`
        });
        
        plotData.push(...traces);
    } else if (Object.keys(processed.stations).length > 0) {
        // Which stations to show
        let stationsToShow = [];
        
        // If comparison is active, use those stations
        if (comparisonStations.length > 0) {
            stationsToShow = comparisonStations;
        } 
        // Otherwise if a specific station is selected
        else if (selectedStation) {
            stationsToShow = [selectedStation];
        } 
        // Otherwise show all stations
        else {
            stationsToShow = Object.keys(processed.stations);
        }
        
        // Create a trace for each station we want to show
        stationsToShow.forEach((stationId, index) => {
            // Skip if station doesn't exist in our data
            if (!processed.stations[stationId]) return;
            
            const stationData = processed.stations[stationId];
            
            // Skip if no data
            if (stationData.length === 0) return;
            
            // Sort by date and hour
            stationData.sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return parseInt(a.hour) - parseInt(b.hour);
            });
            
            // Generate a color based on index for consistent station colors
            const hue = (index * 137) % 360;  // Use golden ratio to distribute colors
            const stationColor = `hsl(${hue}, 70%, 40%)`;
            
            // Create traces with explicit null gaps (important fix)
            const traces = createTracesWithGaps(stationData, 'date', 'hour', 'value', {
                color: stationColor,
                name: stationId
            });
            
            plotData.push(...traces);
        });
    } else {
        // No data to chart
        chartContainer.innerHTML = '<p>No data available to chart</p>';
        return;
    }
    
    // Create the plot
    Plotly.newPlot(chartContainer, plotData, layout, {responsive: true});
}

// Helper function to create trace segments with proper gaps for null values
function createTracesWithGaps(data, dateField, timeField, valueField, options) {
    const result = [];
    let currentSegment = [];
    
    // Process the data points
    for (let i = 0; i < data.length; i++) {
        const item = data[i];
        
        // If this is a valid data point, add it to the current segment
        if (item[valueField] !== null && item[valueField] !== undefined) {
            currentSegment.push(item);
            
            // If this is the last item, add the segment
            if (i === data.length - 1 && currentSegment.length > 0) {
                result.push(createTraceSegment(currentSegment, dateField, timeField, valueField, options, result.length));
            }
        } 
        // If we hit a null value
        else {
            // If we have points in the current segment, finalize it
            if (currentSegment.length > 0) {
                result.push(createTraceSegment(currentSegment, dateField, timeField, valueField, options, result.length));
                currentSegment = []; // Reset the segment
            }
        }
    }
    
    return result;
}

// Helper function to create a trace segment
function createTraceSegment(segment, dateField, timeField, valueField, options, segmentIndex) {
    // Extract x and y values
    const x = segment.map(item => `${item[dateField]} ${item[timeField]}:00`);
    const y = segment.map(item => item[valueField]);
    
    // Create the trace
    return {
        x: x,
        y: y,
        mode: 'lines',
        line: {
            color: options.color || 'black',
            width: 1.5
        },
        name: options.name || '',
        // Only show in legend for the first segment
        showlegend: segmentIndex === 0
    };
}
            

            // Helper function to get parameter unit
            function getParameterUnit(parameter) {
                const units = {
                    'o3': 'ppb',
                    'o3_8h': 'ppb',
                    'pm10': 'μg/m³',
                    'pm10nowCast': 'μg/m³',
                    'pm25': 'μg/m³',
                    'pm25nowCast': 'μg/m³',
                    'nox': 'ppb',
                    'no2': 'ppb',
                    'no': 'ppb',
                    'co': 'ppm',
                    'so2': 'ppb',
                    'wsp': 'm/s',
                    'wdr': '°',
                    'tmp': '°C',
                    'rh': '%'
                };
                
                return units[parameter] || '';
            }
            
            // Helper function to get contrast color for text (black or white)
            function getContrastColor(hexColor) {
                // Convert hex to RGB
                let r, g, b;
                
                if (hexColor.startsWith('#')) {
                    r = parseInt(hexColor.slice(1, 3), 16);
                    g = parseInt(hexColor.slice(3, 5), 16);
                    b = parseInt(hexColor.slice(5, 7), 16);
                } else if (hexColor.startsWith('rgb')) {
                    const rgbValues = hexColor.match(/\d+/g);
                    r = parseInt(rgbValues[0]);
                    g = parseInt(rgbValues[1]);
                    b = parseInt(rgbValues[2]);
                } else {
                    return '#000000'; // Default to black for unknown formats
                }
                
                // Calculate luminance (perceived brightness)
                // Formula: 0.299r + 0.587g + 0.114b
                const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                
                // Use white for dark colors, black for light colors
                return luminance > 0.5 ? '#000000' : '#ffffff';
            }
        });
    </script>
</body>
</html>
